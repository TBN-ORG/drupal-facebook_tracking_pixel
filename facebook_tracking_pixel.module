<?php

/**
 * @file facebook_tracking_pixel.module
 * Facebook Tracking Module.
 *
 * @author Brady Owens <info@fastglass.net>
 */

/**
 * Implements hook_menu().
 */
function facebook_tracking_pixel_menu() {
  $items = array();

  $items['admin/config/system/facebook_tracking_pixel'] = [
    'title' => 'Administer Facebook Tracking Pixel',
    'description' => 'Facebook Tracking pixel module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_settings_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  ];
  $items['admin/config/system/facebook_tracking_pixel/default'] = [
    'title' => 'Administer Facebook Tracking Pixel',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  ];
  $items['admin/config/system/facebook_tracking_pixel/base_codes'] = [
    'title' => 'Base Tracking Codes',
    'page arguments' => ['facebook_tracking_pixel_base_codes_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.inc',
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/config/system/facebook_tracking_pixel/base_codes/add'] = [
    'title' => 'Add a Base Code',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_base_codes_add_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_LOCAL_ACTION,
  ];
  $items['admin/config/system/facebook_tracking_pixel/base_codes/delete/%tid'] = [
    'load arguments' => [6],
    'title' => 'Delete a Base Code',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_base_codes_delete_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_CONTEXT_NONE,
  ];
  $items['admin/config/system/facebook_tracking_pixel/base_codes/edit/%tid'] = [
    'load arguments' => [6],
    'title' => 'Edit a Base Code',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_base_codes_edit_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_CONTEXT_NONE,
  ];
  $items['admin/config/system/facebook_tracking_pixel/purge'] = [
    'title' => 'Purge',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_form_purge'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.inc',
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/config/system/facebook_tracking_pixel/path'] = [
    'title' => 'Events by Path',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_track_by_path_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_LOCAL_TASK,
  ];
  $items['admin/config/system/facebook_tracking_pixel/path/add'] = [
    'title' => 'Add an event',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_path_add_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_LOCAL_ACTION,
  ];
  $items['admin/config/system/facebook_tracking_pixel/path/delete/%tid'] = [
    'load arguments' => [6],
    'title' => 'Delete an event',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_path_delete_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_CONTEXT_NONE,
  ];
  $items['admin/config/system/facebook_tracking_pixel/path/edit/%tid'] = [
    'load arguments' => [6],
    'title' => 'Edit an event',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['facebook_tracking_pixel_path_edit_form'],
    'access arguments' => ['administer facebook tracking pixels'],
    'file' => 'facebook_tracking_pixel.admin.path.inc',
    'type' => MENU_CONTEXT_NONE,
  ];
  return $items;
}

/**
 * Implements hook_permission().
 */
function facebook_tracking_pixel_permission() {
  $permissions['administer facebook tracking pixels']['title'] = t('Administer Facebook Tracking Pixels.');

  return $permissions;
}

/**
 * Implements hook_page_build().
 */
function facebook_tracking_pixel_page_build(&$page) {
  // This module is disabled if the admin has not agreed to responsibility
  // for the code that will be inserted into the website.
  $agree = variable_get('facebook_tracking_pixel_global_agree' . FALSE);
  if ($agree) {
    // Optional weights.
    $weight = variable_get('facebook_tracking_pixel_weight_js', JS_THEME);
    $files = file_scan_directory(variable_get('facebook_tracking_pixel_path', 'public://facebook_tracking_pixel'), '/.*\.js$/');
    if (!empty($files)) {
      // Only proceed if either this is not an admin page or if the 'load on
      // admin pages too' option was checked.
      $page_is_admin = path_is_admin(current_path());
      $force_on_admin = (bool) variable_get('facebook_tracking_pixel_admin', FALSE);
      if (!$page_is_admin || $force_on_admin) {
        $i = 0;
        foreach ($files as $key => $value) {
          $page['content']['#attached']['js']['facebook_tracking_pixel_' . $i] = array(
            'type' => 'file',
            'group' => JS_THEME,
            'weight' => $weight - 2,
            'data' => $key,
            'preprocess' => (bool) variable_get('facebook_tracking_pixel_aggregation', FALSE),
          );
          $i++;
        }
      }
    }

    // Pull base code IDs from database and build the noscript header includes.
    $result = db_select('facebook_tracking_pixel_base_codes', 'c')
      ->fields('c')
      ->orderBy('weight')
      ->execute()
      ->fetchAllAssoc('base_code_id');
    // Facebook static code.
    $fb_noscript_src = [
      '<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=',
      '&ev=PageView&noscript=1"/></noscript>',
    ];
    if ($result) {
      foreach ($result as $element) {
        // Assemble code.
        $fb_base_code_nojs = $fb_noscript_src[0] . $element->base_code_fbid . $fb_noscript_src[1];
        drupal_add_html_head([
          '#type' => 'markup',
          '#markup' => $fb_base_code_nojs,
          '#weight' => 200
        ], 'facebook_tracking_pixel_noscript');
      }
    }
  }
}

/**
 * Deletes all CSS & JavaScript from the file system or a single file.
 *
 * @param null $filename
 * @return bool
 */
function facebook_tracking_pixel_delete_file($filename = NULL) {
  $path = variable_get('facebook_tracking_pixel_path', 'public://facebook_tracking_pixel');
  // Calling the function without a file name will delete everything.
  if ($filename == NULL) {
    if (!$files = file_scan_directory($path, '/.*\.js$/')) {
      foreach ($files as $key => $value) {
        file_unmanaged_delete($path . '/' . $key);
      }
      return TRUE;
    }
  } else {
    file_unmanaged_delete($path . '/' . $filename);
    return TRUE;
  }
  return FALSE;
}

/**
 * Saves JavaScript in the file system (but only if not empty).
 *
 * @param $data
 * @param $filename
 * @param null $subdir
 * @return bool|null|string
 */
function facebook_tracking_pixel_save_file($data, $filename, $subdir = NULL) {
  if (!drupal_strlen(trim($data))) {
    return FALSE;
  }
  $path = variable_get('facebook_tracking_pixel_path', 'public://facebook_tracking_pixel');
  if (!empty($subdir)) {
    $path = $path . '/' . $subdir;
  }
  file_prepare_directory($path, FILE_CREATE_DIRECTORY);
  $file_saved = file_unmanaged_save_data($data, $path . '/' . $filename, FILE_EXISTS_REPLACE);

  // Trigger reloading the CSS and JS file cache in AdvAgg, if available.
  if ($file_saved && module_exists('advagg')) {
    module_load_include('inc', 'advagg', 'advagg.cache');
    advagg_push_new_changes();
  }

  return $file_saved;
}

/**
 * Return keyed array of standard events.
 *
 * @return array
 */

function facebook_tracking_pixel_events() {
  $events = [];
  $events['pageview'] = [
    'name' => t('Key Page View'),
    'code' => 'fbq(\'track\', \'ViewContent\');'
  ];
  $events['search'] = [
    'name' => t('Search'),
    'code' => 'fbq(\'track\', \'Search\');'
  ];
  $events['addtocart'] = [
    'name' => t('Add to Cart'),
    'code' => 'fbq(\'track\', \'AddToCart\');'
  ];
  $events['addtowish'] = [
    'name' => t('Add to Wishlist'),
    'code' => 'fbq(\'track\', \'AddToWishlist\');'
  ];
  $events['checkoutstart'] = [
    'name' => t('Initiate checkout'),
    'code' => 'fbq(\'track\', \'InitiateCheckout\');'
  ];
  $events['addpayment'] = [
    'name' => t('Add Payment Info'),
    'code' => 'fbq(\'track\', \'AddPaymentInfo\')'
  ];
  $events['lead'] = [
    'name' => t('Lead'),
    'code' => 'fbq(\'track\', \'Lead\');'
  ];
  $events['registration'] = [
    'name' => t('Complete Registration'),
    'code' => 'fbq(\'track\', \'CompleteRegistration\');'
  ];
  return $events;
}

/**
 * Return keyed array of standard events in a format for select boxes.
 *
 * @return array
 */

function facebook_tracking_pixel_events_options() {
  $events = [];
  $events['pageview'] = t('Key Page View');
  $events['search'] = t('Search');
  $events['addtocart'] = t('Add to Cart');
  $events['addtowish'] = t('Add to Wishlist');
  $events['checkoutstart'] = t('Initiate checkout');
  $events['addpayment'] = t('Add Payment Info');
  $events['lead'] = t('Lead');
  $events['registration'] = t('Complete Registration');
  return $events;
}

/**
 * Implements hook_theme().
 */
function facebook_tracking_pixel_theme() {
  return [
    'facebook_tracking_pixel_base_codes_form' => [
      'render element' => 'form',
      'file' => 'facebook_tracking_pixel.admin.inc',
    ],
  ];
}
